<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="stylesheet" href="style.css">
</head>
<style>
    /* Add these styles to your existing stylesheet or create a new one */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
  
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
    }
  </style>
  

<body>
    <div class="bod" id="pinSection">
        <div class="man">
            <h2>Enter PIN Code</h2>
            <p id="pinErrorMessage"></p>
            <form id="pinForm">
                <input type="password" id="pin" name="pin" placeholder="Enter PIN" required>
                <button type="button" onclick="submitPinForm()">Submit</button>
            </form>
        </div>
    </div>

    <div id="dataSection" style="display: none;">

      <div class="bod">
        <div class="man">
            <h2>UDDOG ID</h2>
            <p id="errorMessage"></p>
            <form id="myForm">
                <input autocomplete="off" placeholder="ENTER USERNAME" type="text" id="username" name="username" required><br>
                <label for="dataInput"></label>
                <input autocomplete="off" placeholder="Enter amount" type="text" id="dataInput" name="dataInput" required>
                <button type="button" onclick="submitDataForm()">Login / Write to Spreadsheet</button>
            </form>
         </div>
        </div>

    </div>

    <!-- Loading Modal -->
<div id="loadingModal" class="modal" style="display: none;">
    <div class="modal-content">
      <p>Loading...</p>
    </div>
  </div>
  

    <script>
        


        document.addEventListener('DOMContentLoaded', function () {
            const lastEnteredTime = localStorage.getItem('lastEnteredTime');
            const pinSection = document.getElementById('pinSection');
            const dataSection = document.getElementById('dataSection');

            if (lastEnteredTime && Date.now() - parseInt(lastEnteredTime) < 600000) {
                // If the user has entered the correct PIN in the last 10 minutes, hide PIN section and show data section
                pinSection.style.display = 'none';
                dataSection.style.display = 'block';
            }
        });

        function submitPinForm() {
            const pinInput = document.getElementById('pin');
            const pin = pinInput.value.trim();
            const pinErrorMessageElement = document.getElementById('pinErrorMessage');
            const pinSection = document.getElementById('pinSection');
            const dataSection = document.getElementById('dataSection');

            // Clear previous error message
            pinErrorMessageElement.textContent = '';

            // Check if the entered PIN is correct
            // Fetch data from CSV and get the correct PIN from B10 cell
            fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSUGSxsH1_lLpIR_agKn32CSir3ll7dghjh9nsMOtmLb4WhIGvL5avrT_aRA2NbQjNAYlnHh9ERBfJA/pub?output=csv')
                .then(response => response.text())
                .then(data => {
                    const rows = data.split('\n').map(row => row.split(','));

                    // Get the correct PIN from B10 cell
                    const correctPin = rows[10][1]; // Assuming B10 is the 10th row (index 9) and 2nd column (index 1)

                    // Check if the entered PIN is correct
                    if (pin === correctPin) {
                        // Hide the PIN entry section
                        pinSection.style.display = 'none';

                        // Show the data section
                        dataSection.style.display = 'block';

                        // Save the timestamp when the correct PIN was entered
                        localStorage.setItem('lastEnteredTime', Date.now().toString());
                    } else {
                        pinErrorMessageElement.textContent = 'Incorrect PIN. Please try again.';
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // ... (previous code)

        function submitDataForm() {
    const usernameInput = document.getElementById('username');
    const username = usernameInput.value.trim();
    const errorMessageElement = document.getElementById('errorMessage');

    // Check if the username input is not empty
    if (username === '') {
        errorMessageElement.textContent = 'Please enter a username.';
        return; // Stop the function if the input is empty
    }

    errorMessageElement.textContent = ''; // Clear previous error message

    // Fetch data from CSV
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSUGSxsH1_lLpIR_agKn32CSir3ll7dghjh9nsMOtmLb4WhIGvL5avrT_aRA2NbQjNAYlnHh9ERBfJA/pub?output=csv')
        .then(response => response.text())
        .then(data => {
            const rows = data.split('\n').map(row => row.split(','));

            // Get the usernames from the third row (index 2)
            const usernames = rows[2];

            // Check if the entered username exists in the usernames array
            const isValid = usernames.includes(username);

            if (isValid) {
                const loadingModal = document.getElementById('loadingModal');
                loadingModal.style.display = 'flex';

                const dataInput = document.getElementById('dataInput').value;

                // Fetch the data from the Google Apps Script endpoint
                fetch('https://script.google.com/macros/s/AKfycby1G9EbzJxEi9uLGE9FZbvEfq46SYPEtLhhpVmqENPlcaQnQ2diCKUMDSGlEBFf39OB/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(dataInput) + '&username=' + encodeURIComponent(username),
                })
                    .then(response => response.text())
                    .then(updateResult => {
                        console.log('Spreadsheet update result:', updateResult);

                        // Handle the success scenario here, e.g., display a success message
                        errorMessageElement.textContent = 'Data added successfully to the spreadsheet!';

                        // Clear the form fields
                        document.getElementById('myForm').reset();
                    })
                    .catch(error => {
                        console.error('Error updating spreadsheet:', error);
                        errorMessageElement.textContent = 'Error updating spreadsheet. Please try again.';
                    })
                    .finally(() => {
                        loadingModal.style.display = 'none';  // Hide loading modal after processing
                    });
            } else {
                errorMessageElement.textContent = 'Wrong username. Please try again.';
            }
        })
        .catch(error => console.error('Error fetching data:', error));
}

    </script>
</body>

</html>
